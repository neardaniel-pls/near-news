<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregador de Notícias de Privacidade</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>Agregador de Notícias de Privacidade</h1>
        <p>A sua fonte diária de notícias sobre privacidade e segurança.</p>
        <nav>
            <a href="{{ url_for('gerir_feeds') }}">Gerir Feeds</a>
        </nav>
    </header>

    <main>
        <div class="search-container">
            <form action="/" method="get">
                <input type="search" name="q" placeholder="Pesquisar artigos..." value="{{ query or '' }}">
                <button type="submit">Pesquisar</button>
            </form>
        </div>

        <div class="feed-noticias">
            {% for artigo in artigos %}
            <article class="item-noticia">
                <h2><a href="{{ artigo.link }}" target="_blank">{{ artigo.titulo }}</a></h2>
                <div class="metadados">
                    <span class="fonte">Fonte: <a href="{{ artigo.url_fonte }}" target="_blank">{{ artigo.nome_fonte }}</a></span>
                    <span class="data">Publicado: {{ artigo.data_publicacao.strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                {% if artigo.resumo %}
                <div class="resumo">{{ artigo.resumo | safe }}</div>
                {% endif %}
                {% if artigo.tags %}
                <div class="tags">
                    <strong>Tags:</strong> {{ artigo.tags }}
                </div>
                {% endif %}
            </article>
            {% else %}
            <p>Nenhuma notícia encontrada. Execute o parser para buscar artigos.</p>
            {% endfor %}
        </div>
    </main>

    <footer>
        <p>Agregador de Notícias de Privacidade e Segurança</p>
    </footer>
</body>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const wordLimit = 100;

    document.querySelectorAll('.resumo').forEach(resumoDiv => {
        const originalHTML = resumoDiv.innerHTML;
        const textContent = resumoDiv.innerText || resumoDiv.textContent;
        const words = textContent.trim().split(/\s+/);

        if (words.length > wordLimit) {
            // Find the end of the 100th word in the HTML
            let truncatedHTML = '';
            let currentWordCount = 0;
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div id="root">${originalHTML}</div>`, 'text/html');
            
            function getTruncatedHTML(node) {
                if (currentWordCount >= wordLimit) return;

                if (node.nodeType === Node.TEXT_NODE) {
                    const nodeWords = node.textContent.trim().split(/\s+/);
                    const wordsToAdd = [];
                    for (const word of nodeWords) {
                        if (currentWordCount < wordLimit) {
                            wordsToAdd.push(word);
                            currentWordCount++;
                        } else {
                            break;
                        }
                    }
                    truncatedHTML += wordsToAdd.join(' ') + ' ';
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    truncatedHTML += `<${node.tagName.toLowerCase()}`;
                    for (const attr of node.attributes) {
                        truncatedHTML += ` ${attr.name}="${attr.value}"`;
                    }
                    truncatedHTML += '>';
                    
                    node.childNodes.forEach(child => getTruncatedHTML(child));
                    
                    truncatedHTML += `</${node.tagName.toLowerCase()}>`;
                }
            }

            doc.getElementById('root').childNodes.forEach(child => getTruncatedHTML(child));

            resumoDiv.innerHTML = truncatedHTML + '...';

            const readMoreBtn = document.createElement('a');
            readMoreBtn.href = '#';
            readMoreBtn.textContent = 'Ler mais';
            readMoreBtn.classList.add('read-more-btn');
            resumoDiv.appendChild(readMoreBtn);

            readMoreBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (this.textContent === 'Ler mais') {
                    resumoDiv.innerHTML = originalHTML;
                    this.textContent = 'Ler menos';
                    resumoDiv.appendChild(this); // Re-append the button
                } else {
                    resumoDiv.innerHTML = truncatedHTML + '...';
                    this.textContent = 'Ler mais';
                    resumoDiv.appendChild(this); // Re-append the button
                }
            });
        }
    });
});
</script>

</html>